<% provide(:title, "Weather") %>
<!DOCTYPE html>
<html>
  <head>
    <title><%= yield(:title) %> | Ruby on Rails Tutorial Sample App</title>
  </head>
  <body>
    <h1>Weather</h1>
    <strong>Button: view, add,remove up to 4 favorites</strong>
    New active records: geo locations of 3000+ cities, favorites (1 User to many Geos)
<%    
require "http"
metadata_response_s=HTTP.get("https://api.weather.gov/points/38.8894,-77.0352")
require "json"
metadata_json=JSON.parse(metadata_response_s) # json is Ruby class: hash
forecast_city= metadata_json.fetch("properties").fetch("relativeLocation").fetch("properties").fetch("city")
forecast_state= metadata_json.fetch("properties").fetch("relativeLocation").fetch("properties").fetch("state")
forecast_url_s=metadata_json.fetch("properties").fetch("forecast")
forecast_response_s=HTTP.get(forecast_url_s)
forecast_hourly_s=HTTP.get(forecast_url_s+"/hourly")
forecast_json=JSON.parse(forecast_response_s)
forecastHourly_json=JSON.parse(forecast_hourly_s)
forecast_datetime=forecastHourly_json.fetch("properties").fetch("updated")
%>

<%
  nt={} 
  nta=[]

  forecastHourly_json.fetch("properties").fetch("periods").each do |p| 
    n=p.fetch("number")
    name=p.fetch("name")
    dt=p.fetch("startTime") #p n+" "+name
    t=p.fetch("temperature")
    nt[n]=t
    nta.push([dt,t])
  end
now_icon=forecastHourly_json.fetch("properties").fetch("periods").at(0).fetch("icon")
now_period_name=forecastHourly_json.fetch("properties").fetch("periods").at(0).fetch("name")
now_shortForecast=forecastHourly_json.fetch("properties").fetch("periods").at(0).fetch("shortForecast")
now_detailedForecast=forecastHourly_json.fetch("properties").fetch("periods").at(0).fetch("detailedForecast")

 %>
 <%#=forecastHourly_json.fetch("properties").fetch("periods").first%>
 <br>
 <table style="text-align:left">
 <tr><td> <strong><%=forecast_city%>, <%=forecast_state%></strong></td></tr>
 <tr><td>
  <img src="<%=now_icon.gsub("small","large")%>" style="border-radius: 50%;">
  </tr></td>
  <tr><td>
    <span><%= now_shortForecast%></span></tr></td>
  <tr><td>
    <%= forecast_datetime[0..9]+" "+forecast_datetime[11..15] %></tr></td>
</table></div>
</div>

  <%#=line_chart(nt)%>
  <strong>Temperatures for the next <%=forecastHourly_json.fetch("properties").fetch("periods").size/24%> days:</strong>
  <%= line_chart nta, xtitle: "", ytitle: "Temperature F" %>
  <%#= line_chart({"2021-01-01" => 2, "2021-01-02" => 3}) %>
  <%#= line_chart( [ ['A', 2] , ['B',3], ['C',1.2]  ]) %>
  <%#= geo_chart Medal.group(:country).count %>
  </body>
</html>